name: Test Single Environment (FE Reusable)

# NOTE: Input Definitions vs. Values
# ===================================
# This reusable workflow MUST define its inputs here (GitHub Actions requirement).
# However, the VALUES passed to these inputs are centralized in ci.yml via the
# `determine-envs` job outputs. This provides:
# - Single source of truth for test configuration in ci.yml
# - Flexibility for other workflows to call this with different values
# - Defaults here allow this workflow to be called without specifying every input
#
# To change which tests run in the main CI pipeline, update the `enable_*_tests`
# outputs in the `determine-envs` job in ci.yml, not the defaults here.

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test (dev, test, prod)'
        required: true
        type: string
      test_suite:
        description: 'Test suite to run (smoke, ci, extended, all)'
        required: false
        type: string
        default: 'smoke'
      browser:
        description: 'Browser to run tests on'
        required: false
        type: string
        default: 'chrome'
      base_url:
        description: 'Base URL for the environment'
        required: true
        type: string
      # Selenium Grid Configurations
      se_hub_host:
        description: 'Selenium Hub Host'
        type: string
        default: 'selenium-hub'
      se_hub_port:
        description: 'Selenium Hub Port'
        type: string
        default: '4444'
      se_pub_port:
        description: 'Selenium Event Bus Publish Port'
        type: string
        default: '4442'
      se_sub_port:
        description: 'Selenium Event Bus Subscribe Port'
        type: string
        default: '4443'
      se_max_sessions:
        description: 'Maximum Selenium Sessions per Node'
        type: string
        default: '5'
      selenium_version:
        description: 'Selenium Grid Docker image version (hub and nodes)'
        type: string
        default: '4.39.0'
      # Test execution controls - Set to true to enable, false to disable
      enable_smoke_tests:
        description: 'Enable Smoke Tests'
        type: boolean
        default: true
      enable_grid_tests:
        description: 'Enable Grid Tests'
        type: boolean
        default: true
      enable_mobile_tests:
        description: 'Enable Mobile Browser Tests'
        type: boolean
        default: true
      enable_responsive_tests:
        description: 'Enable Responsive Design Tests'
        type: boolean
        default: true
      enable_stop_services:
        # SKIPPED: Services automatically stop when job completes (runner is destroyed)
        description: 'Enable Stop Backend and Frontend Services'
        type: boolean
        default: false
      enable_cypress_tests:
        description: 'Enable Cypress Tests'
        type: boolean
        default: true
      enable_playwright_tests:
        description: 'Enable Playwright Tests'
        type: boolean
        default: true
      enable_robot_tests:
        description: 'Enable Robot Framework Tests'
        type: boolean
        default: true
      enable_selenide_tests:
        description: 'Enable Selenide Tests'
        type: boolean
        default: true
      enable_vibium_tests:
        description: 'Enable Vibium Tests'
        type: boolean
        default: true
      # Timeout Configuration - Minutes (all default to 5 minutes)
      smoke_tests_timeout_minutes:
        description: 'Timeout in minutes for Smoke Tests'
        type: number
        default: 5
      grid_tests_timeout_minutes:
        description: 'Timeout in minutes for Grid Tests'
        type: number
        default: 5
      mobile_tests_timeout_minutes:
        description: 'Timeout in minutes for Mobile Browser Tests'
        type: number
        default: 5
      responsive_tests_timeout_minutes:
        description: 'Timeout in minutes for Responsive Design Tests'
        type: number
        default: 5
      cypress_tests_timeout_minutes:
        description: 'Timeout in minutes for Cypress Tests'
        type: number
        default: 5
      playwright_tests_timeout_minutes:
        description: 'Timeout in minutes for Playwright Tests'
        type: number
        default: 5
      robot_tests_timeout_minutes:
        description: 'Timeout in minutes for Robot Framework Tests'
        type: number
        default: 5
      selenide_tests_timeout_minutes:
        description: 'Timeout in minutes for Selenide Tests'
        type: number
        default: 5
      vibium_tests_timeout_minutes:
        description: 'Timeout in minutes for Vibium Tests'
        type: number
        default: 5
      # Version Configuration
      java_version:
        description: 'Java version for JDK setup'
        type: string
        default: '21'
      python_version:
        description: 'Python version for setup-python'
        type: string
        default: '3.11'
      node_version:
        description: 'Node.js version for setup-node'
        type: string
        default: '20'
      # Test Configuration
      test_retry_count:
        description: 'Number of retries for failed tests'
        type: number
        default: 1
      # Timeout Configuration - Seconds (for service/grid waits)
      grid_wait_timeout_seconds:
        description: 'Timeout in seconds for waiting for Selenium Grid'
        type: number
        default: 5
      service_wait_timeout_seconds:
        description: 'Timeout in seconds for waiting for services (frontend/backend)'
        type: number
        default: 5
      # Resource Configuration
      maven_memory:
        description: 'Maven heap size (e.g., 2048m, 4096m)'
        type: string
        default: '4096m'
      allure_version:
        description: 'Allure3 CLI version (default: 3.0.0)'
        type: string
        default: '3.0.0'
      docker_shm_size:
        description: 'Docker shared memory size for Selenium nodes (e.g., 2gb, 4gb)'
        type: string
        default: '2gb'

env:
  JAVA_VERSION: ${{ inputs.java_version || '21' }}
  MAVEN_OPTS: -Xmx${{ inputs.maven_memory || '4096m' }} -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
  # Default Selenium Grid hub URL for CI runs
  SELENIUM_REMOTE_URL: http://localhost:${{ inputs.se_hub_port }}/wd/hub

jobs:
  # DISABLED: All test jobs temporarily disabled
  # tests-disabled:
  #   name: Tests Disabled (${{ inputs.environment }})
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Tests Disabled Notice
  #       run: |
  #         echo "âš ï¸  All test jobs are temporarily disabled"
  #         echo "This is intentional while development work is in progress"

  smoke-tests:
    name: Smoke Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_smoke_tests == true

    services:
      selenium-hub:
        image: selenium/hub:${{ inputs.selenium_version }}
        ports:
          - ${{ inputs.se_hub_port }}:${{ inputs.se_hub_port }}
          - ${{ inputs.se_pub_port }}:${{ inputs.se_pub_port }}
          - ${{ inputs.se_sub_port }}:${{ inputs.se_sub_port }}

      chrome-node:
        image: selenium/node-chrome:${{ inputs.selenium_version }}
        env:
          SE_EVENT_BUS_HOST: ${{ inputs.se_hub_host }}
          SE_EVENT_BUS_PUBLISH_PORT: ${{ inputs.se_pub_port }}
          SE_EVENT_BUS_SUBSCRIBE_PORT: ${{ inputs.se_sub_port }}
          SE_NODE_MAX_SESSIONS: ${{ inputs.se_max_sessions }}
        options: --shm-size=${{ inputs.docker_shm_size || '2gb' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || '21' }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download compiled classes from build-and-compile job
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: compiled-classes
          path: pre-compiled-classes
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for Selenium Grid
        run: |
          ./scripts/ci/wait-for-grid.sh "http://localhost:${{ inputs.se_hub_port }}/wd/hub/status" "${{ inputs.grid_wait_timeout_seconds || 5 }}"

      - name: Run Smoke Tests
        timeout-minutes: ${{ inputs.smoke_tests_timeout_minutes || 5 }}
        env:
          SELENIUM_REMOTE_URL: http://localhost:${{ inputs.se_hub_port }}/wd/hub
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”¥ Smoke Tests - ${{ inputs.environment }} Environment"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.base_url }}"
          echo ""
          ./scripts/ci/run-maven-tests.sh \
            "${{ inputs.environment }}" \
            "testng-smoke-suite.xml" \
            "${{ inputs.test_retry_count || 1 }}"

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-results-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 3
          if-no-files-found: ignore

  grid-tests:
    name: Grid Tests - ${{ matrix.browser }} (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_grid_tests == true
    # No dependencies - runs in PARALLEL with smoke, mobile, and responsive

    strategy:
      matrix:
        browser: [chrome, firefox, edge]
      fail-fast: false

    services:
      selenium-hub:
        image: selenium/hub:${{ inputs.selenium_version }}
        ports:
          - ${{ inputs.se_hub_port }}:${{ inputs.se_hub_port }}
          - ${{ inputs.se_pub_port }}:${{ inputs.se_pub_port }}
          - ${{ inputs.se_sub_port }}:${{ inputs.se_sub_port }}

      chrome-node:
        image: selenium/node-chrome:${{ inputs.selenium_version }}
        env:
          SE_EVENT_BUS_HOST: ${{ inputs.se_hub_host }}
          SE_EVENT_BUS_PUBLISH_PORT: ${{ inputs.se_pub_port }}
          SE_EVENT_BUS_SUBSCRIBE_PORT: ${{ inputs.se_sub_port }}
          SE_NODE_MAX_SESSIONS: ${{ inputs.se_max_sessions }}
        options: --shm-size=${{ inputs.docker_shm_size || '2gb' }}

      firefox-node:
        image: selenium/node-firefox:${{ inputs.selenium_version }}
        env:
          SE_EVENT_BUS_HOST: ${{ inputs.se_hub_host }}
          SE_EVENT_BUS_PUBLISH_PORT: ${{ inputs.se_pub_port }}
          SE_EVENT_BUS_SUBSCRIBE_PORT: ${{ inputs.se_sub_port }}
          SE_NODE_MAX_SESSIONS: ${{ inputs.se_max_sessions }}
        options: --shm-size=${{ inputs.docker_shm_size || '2gb' }}

      edge-node:
        image: selenium/node-edge:${{ inputs.selenium_version }}
        env:
          SE_EVENT_BUS_HOST: ${{ inputs.se_hub_host }}
          SE_EVENT_BUS_PUBLISH_PORT: ${{ inputs.se_pub_port }}
          SE_EVENT_BUS_SUBSCRIBE_PORT: ${{ inputs.se_sub_port }}
          SE_NODE_MAX_SESSIONS: ${{ inputs.se_max_sessions }}
        options: --shm-size=${{ inputs.docker_shm_size || '2gb' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || '21' }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          echo "â³ Waiting for Grid..."
          timeout ${{ inputs.grid_wait_timeout_seconds || 5 }} bash -c 'until curl -sf http://localhost:${{ inputs.se_hub_port }}/wd/hub/status; do sleep 1; done'
          # No sleep needed - curl success confirms Grid is ready
          echo "âœ… Grid ready!"

      - name: Run Grid Tests
        timeout-minutes: ${{ inputs.grid_tests_timeout_minutes || 5 }}
        env:
          SELENIUM_REMOTE_URL: http://localhost:${{ inputs.se_hub_port }}/wd/hub
          BROWSER: ${{ matrix.browser }}
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Grid Tests - ${{ matrix.browser }} - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "Browser: ${{ matrix.browser }}"
          echo "URL: ${{ inputs.base_url }}"
          echo "Suite: ${{ inputs.test_suite }}"
          echo ""

          # Create Allure environment properties file
          ./scripts/ci/create-allure-env-properties.sh \
            "${{ inputs.environment }}" \
            "${{ matrix.browser }}" \
            "${{ inputs.se_hub_port }}" \
            "${{ inputs.base_url }}" \
            "${{ inputs.test_suite }}" \
            "Grid.Type=Selenium Grid"

          ./scripts/ci/run-maven-tests.sh \
            "${{ inputs.environment }}" \
            "testng-${{ inputs.test_suite }}-suite.xml" \
            "${{ inputs.test_retry_count || 1 }}" \
            "${{ matrix.browser }}"

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Grid Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grid-results-${{ matrix.browser }}-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 3
          if-no-files-found: ignore

  mobile-browser-tests:
    name: Mobile Browser Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_mobile_tests == true
    # No dependencies - runs in PARALLEL with smoke, grid, and responsive

    services:
      selenium-hub:
        image: selenium/hub:${{ inputs.selenium_version }}
        ports:
          - ${{ inputs.se_hub_port }}:${{ inputs.se_hub_port }}

      chrome-node:
        image: selenium/node-chrome:${{ inputs.selenium_version }}
        env:
          SE_EVENT_BUS_HOST: ${{ inputs.se_hub_host }}
          SE_EVENT_BUS_PUBLISH_PORT: ${{ inputs.se_pub_port }}
          SE_EVENT_BUS_SUBSCRIBE_PORT: ${{ inputs.se_sub_port }}
          SE_NODE_MAX_SESSIONS: 2
        options: --shm-size=${{ inputs.docker_shm_size || '2gb' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || '21' }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download compiled classes from build-and-compile job
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: compiled-classes
          path: pre-compiled-classes
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for Selenium Grid
        run: |
          timeout ${{ inputs.grid_wait_timeout_seconds || 5 }} bash -c 'until curl -sf http://localhost:${{ inputs.se_hub_port }}/wd/hub/status; do sleep 1; done'
          # No sleep needed - curl success confirms Grid is ready
          echo "âœ… Grid ready!"

      - name: Run Mobile Browser Tests
        timeout-minutes: ${{ inputs.mobile_tests_timeout_minutes || 5 }}
        env:
          SELENIUM_REMOTE_URL: http://localhost:${{ inputs.se_hub_port }}/wd/hub
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“± Mobile Browser Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.base_url }}"
          echo ""

          # Create Allure environment properties file
          ./scripts/ci/create-allure-env-properties.sh \
            "${{ inputs.environment }}" \
            "Chrome Mobile" \
            "${{ inputs.se_hub_port }}" \
            "${{ inputs.base_url }}" \
            "mobile-browser" \
            "Device.Type=Mobile Viewport"

          ./scripts/ci/run-maven-tests.sh \
            "${{ inputs.environment }}" \
            "testng-mobile-browser-suite.xml" \
            "${{ inputs.test_retry_count || 1 }}"

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Mobile Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-results-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 3
          if-no-files-found: ignore

  responsive-design-tests:
    name: Responsive Design Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_responsive_tests == true
    # No dependencies - runs in PARALLEL with smoke, grid, and mobile

    services:
      selenium-hub:
        image: selenium/hub:${{ inputs.selenium_version }}
        ports:
          - ${{ inputs.se_hub_port }}:${{ inputs.se_hub_port }}

      chrome-node:
        image: selenium/node-chrome:${{ inputs.selenium_version }}
        env:
          SE_EVENT_BUS_HOST: ${{ inputs.se_hub_host }}
          SE_EVENT_BUS_PUBLISH_PORT: ${{ inputs.se_pub_port }}
          SE_EVENT_BUS_SUBSCRIBE_PORT: ${{ inputs.se_sub_port }}
          SE_NODE_MAX_SESSIONS: 2
        options: --shm-size=${{ inputs.docker_shm_size || '2gb' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || '21' }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download compiled classes from build-and-compile job
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: compiled-classes
          path: pre-compiled-classes
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for Selenium Grid
        run: |
          timeout ${{ inputs.grid_wait_timeout_seconds || 5 }} bash -c 'until curl -sf http://localhost:${{ inputs.se_hub_port }}/wd/hub/status; do sleep 1; done'
          # No sleep needed - curl success confirms Grid is ready
          echo "âœ… Grid ready!"

      - name: Run Responsive Design Tests
        timeout-minutes: ${{ inputs.responsive_tests_timeout_minutes || 5 }}
        env:
          SELENIUM_REMOTE_URL: http://localhost:${{ inputs.se_hub_port }}/wd/hub
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Responsive Design Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.base_url }}"
          echo ""

          # Create Allure environment properties file
          ./scripts/ci/create-allure-env-properties.sh \
            "${{ inputs.environment }}" \
            "Chrome" \
            "${{ inputs.se_hub_port }}" \
            "${{ inputs.base_url }}" \
            "responsive" \
            "Screen.Sizes=Desktop, Tablet, Mobile"

          ./scripts/ci/run-maven-tests.sh \
            "${{ inputs.environment }}" \
            "testng-responsive-suite.xml" \
            "${{ inputs.test_retry_count || 1 }}"

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Responsive Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: responsive-results-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 3
          if-no-files-found: ignore

  cypress-tests:
    name: Cypress Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_cypress_tests == true
    # No dependencies - runs in PARALLEL with smoke, grid, mobile, responsive, and playwright

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}
          cache: 'npm'
          cache-dependency-path: cypress/package-lock.json

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Install Cypress dependencies
        working-directory: ./cypress
        run: npm ci

      - name: Install system dependencies for Cypress
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2t64 || sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2

      - name: Run Cypress Tests
        timeout-minutes: ${{ inputs.cypress_tests_timeout_minutes || 5 }}
        working-directory: ./cypress
        env:
          CYPRESS_BASE_URL: ${{ inputs.base_url }}
          TEST_ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¬ Cypress Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          BASE_URL="${{ inputs.base_url }}"
          if [ -z "$BASE_URL" ]; then
            BASE_URL="https://www.google.com"
          fi
          echo "Base URL: $BASE_URL"
          export CYPRESS_BASE_URL="$BASE_URL"
          echo ""
          xvfb-run -a npm run cypress:run

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Cypress Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results-${{ inputs.environment }}
          path: |
            cypress/cypress/videos/
            cypress/cypress/screenshots/
            cypress/cypress/results/
          retention-days: 3
          if-no-files-found: ignore

  playwright-tests:
    name: Playwright Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_playwright_tests == true
    # No dependencies - runs in PARALLEL with smoke, grid, mobile, responsive, and cypress

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}
          cache: 'npm'
          cache-dependency-path: playwright/package-lock.json

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Install Playwright dependencies
        working-directory: ./playwright
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./playwright
        run: npx playwright install --with-deps chromium

      - name: Run Playwright Tests
        timeout-minutes: ${{ inputs.playwright_tests_timeout_minutes || 5 }}
        working-directory: ./playwright
        env:
          BASE_URL: ${{ inputs.base_url }}
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          CI: true
          # Playwright doesn't use Selenium Grid - unset to avoid conflicts
          SELENIUM_REMOTE_URL: ''
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ­ Playwright Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          BASE_URL="${{ inputs.base_url }}"
          if [ -z "$BASE_URL" ]; then
            BASE_URL="https://www.google.com"
          fi
          echo "Base URL: $BASE_URL"
          export BASE_URL="$BASE_URL"
          echo ""
          npm test

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Playwright Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ inputs.environment }}
          path: |
            playwright/test-results/
            playwright/playwright-report/
          retention-days: 3
          if-no-files-found: ignore

  robot-tests:
    name: Robot Framework Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_robot_tests == true
    # No dependencies - runs in PARALLEL with smoke, grid, mobile, responsive, cypress, playwright, and selenide

    services:
      selenium-hub:
        image: selenium/hub:${{ inputs.selenium_version }}
        ports:
          - ${{ inputs.se_hub_port }}:${{ inputs.se_hub_port }}
          - ${{ inputs.se_pub_port }}:${{ inputs.se_pub_port }}
          - ${{ inputs.se_sub_port }}:${{ inputs.se_sub_port }}

      chrome-node:
        image: selenium/node-chrome:${{ inputs.selenium_version }}
        env:
          SE_EVENT_BUS_HOST: ${{ inputs.se_hub_host }}
          SE_EVENT_BUS_PUBLISH_PORT: ${{ inputs.se_pub_port }}
          SE_EVENT_BUS_SUBSCRIBE_PORT: ${{ inputs.se_sub_port }}
          SE_NODE_MAX_SESSIONS: ${{ inputs.se_max_sessions }}
        options: --shm-size=${{ inputs.docker_shm_size || '2gb' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Install Robot Framework dependencies
        run: |
          ./scripts/ci/install-robot-framework.sh

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || '21' }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Selenium Grid
        run: |
          ./scripts/ci/wait-for-grid.sh "http://localhost:${{ inputs.se_hub_port }}/wd/hub/status" "${{ inputs.grid_wait_timeout_seconds || 5 }}"

      - name: Run Robot Framework Tests
        timeout-minutes: ${{ inputs.robot_tests_timeout_minutes || 5 }}
        env:
          SELENIUM_REMOTE_URL: http://localhost:${{ inputs.se_hub_port }}/wd/hub
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
          PYTHON_EXE: ${{ env.PYTHON_EXE || 'python3' }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¤– Robot Framework Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          BASE_URL="${{ inputs.base_url }}"
          
          # When using Selenium Grid (container), localhost points to the container itself.
          # Need to use the Docker bridge gateway to reach services on the host.
          # - GitHub Actions (Linux): Use 172.17.0.1 (Docker bridge gateway)
          # - Docker Desktop (macOS/Windows): Use host.docker.internal
          if [[ "$BASE_URL" == http://localhost:* ]]; then
            if [ -n "$GITHUB_ACTIONS" ]; then
              # GitHub Actions: Use Docker bridge gateway IP
              BASE_URL="${BASE_URL/localhost/172.17.0.1}"
              echo "ğŸ”§ GitHub Actions detected: Using Docker bridge gateway (172.17.0.1)"
            else
              # Local/Docker Desktop: Use host.docker.internal
              BASE_URL="${BASE_URL/localhost/host.docker.internal}"
              echo "ğŸ”§ Local/Docker Desktop: Using host.docker.internal"
            fi
          fi
          
          if [ -z "$BASE_URL" ]; then
            BASE_URL="https://www.google.com"
          fi
          echo "Base URL: $BASE_URL"
          echo "Python executable: $PYTHON_EXE"
          echo ""
          
          # Run Robot Framework tests directly using Python (not Maven plugin)
          # The Maven plugin uses Jython which doesn't have access to pip-installed libraries
          # So we run tests directly with the Python executable that has the libraries
          # Global retry: Run tests, and if they fail, retry once
          "$PYTHON_EXE" -m robot.run \
            --outputdir target/robot-reports \
            --log log.html \
            --report report.html \
            --variable BASE_URL:"$BASE_URL" \
            --variable SELENIUM_REMOTE_URL:"$SELENIUM_REMOTE_URL" \
            src/test/robot/ || {
            echo "âš ï¸ First run failed, retrying once..."
            "$PYTHON_EXE" -m robot.run \
              --outputdir target/robot-reports \
              --log log.html \
              --report report.html \
              --variable BASE_URL:"$BASE_URL" \
              --variable SELENIUM_REMOTE_URL:"$SELENIUM_REMOTE_URL" \
              src/test/robot/
          }
          
          # Convert Robot Framework output to Maven surefire format for CI reporting
          if [ -f target/robot-reports/output.xml ]; then
            echo "âœ… Robot Framework tests completed"
            echo "Results: target/robot-reports/"
          else
            echo "âš ï¸ Robot Framework output not found"
            exit 1
          fi

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Robot Framework Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-results-${{ inputs.environment }}
          path: |
            target/robot-reports/
          retention-days: 3
          if-no-files-found: ignore

  selenide-tests:
    name: Selenide Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_selenide_tests == true
    # No dependencies - runs in PARALLEL with smoke, grid, mobile, responsive, cypress, and playwright

    services:
      selenium-hub:
        image: selenium/hub:${{ inputs.selenium_version }}
        ports:
          - ${{ inputs.se_hub_port }}:${{ inputs.se_hub_port }}
          - ${{ inputs.se_pub_port }}:${{ inputs.se_pub_port }}
          - ${{ inputs.se_sub_port }}:${{ inputs.se_sub_port }}

      chrome-node:
        image: selenium/node-chrome:${{ inputs.selenium_version }}
        env:
          SE_EVENT_BUS_HOST: ${{ inputs.se_hub_host }}
          SE_EVENT_BUS_PUBLISH_PORT: ${{ inputs.se_pub_port }}
          SE_EVENT_BUS_SUBSCRIBE_PORT: ${{ inputs.se_sub_port }}
          SE_NODE_MAX_SESSIONS: ${{ inputs.se_max_sessions }}
        options: --shm-size=${{ inputs.docker_shm_size || '2gb' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || '21' }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download compiled classes from build-and-compile job
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: compiled-classes
          path: pre-compiled-classes
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for Selenium Grid
        run: |
          ./scripts/ci/wait-for-grid.sh "http://localhost:${{ inputs.se_hub_port }}/wd/hub/status" "${{ inputs.grid_wait_timeout_seconds || 5 }}"

      - name: Run Selenide Tests
        timeout-minutes: ${{ inputs.selenide_tests_timeout_minutes || 5 }}
        env:
          SELENIUM_REMOTE_URL: http://localhost:${{ inputs.se_hub_port }}/wd/hub
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Selenide Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.base_url }}"
          echo ""

          # Create Allure environment properties file
          ./scripts/ci/create-allure-env-properties.sh \
            "${{ inputs.environment }}" \
            "Chrome" \
            "${{ inputs.se_hub_port }}" \
            "${{ inputs.base_url }}" \
            "selenide" \
            "Framework=Selenide"

          ./scripts/ci/run-maven-tests.sh \
            "${{ inputs.environment }}" \
            "testng-selenide-suite.xml" \
            "${{ inputs.test_retry_count || 1 }}"

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Selenide Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selenide-results-${{ inputs.environment }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 3
          if-no-files-found: ignore

  vibium-tests:
    name: Vibium Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest
    if: inputs.enable_vibium_tests == true
    # No dependencies - runs in PARALLEL with smoke, grid, mobile, responsive, cypress, playwright, robot, and selenide

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}
          cache: 'npm'
          cache-dependency-path: vibium/package-lock.json

      - name: Start Backend and Frontend Services
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting backend and frontend services..."
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          ./scripts/start-services-for-ci.sh

      - name: Verify Services Are Running
        if: inputs.base_url == 'http://localhost:3003' || inputs.base_url == 'http://localhost:3004' || inputs.base_url == 'http://localhost:3005' || startsWith(inputs.base_url, 'http://localhost')
        run: |
          ./scripts/ci/verify-services.sh \
            "${{ inputs.base_url }}" \
            "${{ inputs.service_wait_timeout_seconds || 5 }}"

      - name: Install Vibium dependencies
        working-directory: ./vibium
        run: |
          echo "ğŸ“¦ Installing Vibium dependencies..."
          # Use npm install instead of npm ci to allow optional dependencies to install based on platform
          # Optional dependencies will automatically install the correct platform package:
          # - @vibium/darwin-arm64 on macOS ARM64
          # - @vibium/linux-x64 on Linux x64
          npm install --no-audit --no-fund
          # Verify core package is installed
          echo "âœ… Verifying installation..."
          npm list vibium || {
            echo "âŒ Core vibium package not installed!"
            exit 1
          }
          echo "âœ… Vibium dependencies installed successfully"

      - name: Run Vibium Tests
        timeout-minutes: ${{ inputs.vibium_tests_timeout_minutes || 5 }}
        env:
          TEST_ENVIRONMENT: ${{ inputs.environment }}
          BASE_URL: ${{ inputs.base_url }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Vibium Tests - ${{ inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.base_url }}"
          echo ""
          ./scripts/run-vibium-tests.sh

      - name: Stop Backend and Frontend Services
        if: inputs.enable_stop_services == true
        run: |
          ./scripts/stop-services.sh || true

      - name: Upload Vibium Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vibium-results-${{ inputs.environment }}
          path: |
            vibium/test-results/
            vibium/coverage/
            vibium/.vitest/
          retention-days: 3
          if-no-files-found: ignore

  environment-allure-report:
    name: Allure Report (${{ inputs.environment }})
    runs-on: ubuntu-latest
    needs: [smoke-tests, grid-tests, mobile-browser-tests, responsive-design-tests, cypress-tests, playwright-tests, robot-tests, selenide-tests, vibium-tests]  # Wait for ALL tests
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List available artifacts (debug)
        if: always()
        run: |
          echo "ğŸ” Checking for artifacts matching pattern: *-results-${{ inputs.environment }} and *-report-${{ inputs.environment }}"
          echo "Expected artifact patterns:"
          echo "  - smoke-results-${{ inputs.environment }}"
          echo "  - grid-results-*-${{ inputs.environment }}"
          echo "  - mobile-results-${{ inputs.environment }}"
          echo "  - responsive-results-${{ inputs.environment }}"
          echo "  - cypress-results-${{ inputs.environment }}"
          echo "  - playwright-results-${{ inputs.environment }}"
          echo "  - robot-results-${{ inputs.environment }}"
          echo "  - selenide-results-${{ inputs.environment }}"
          echo "  - vibium-results-${{ inputs.environment }}"
          echo "  - allure-report-${{ inputs.environment }}"

      - name: Download all test results for this environment
        id: download-results
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: |
            *-results-${{ inputs.environment }}
            allure-report-${{ inputs.environment }}
          path: test-results
          merge-multiple: true

      - name: Prepare Allure results
        if: always()
        run: |
          chmod +x scripts/ci/prepare-environment-allure-results.sh
          ./scripts/ci/prepare-environment-allure-results.sh "${{ inputs.environment }}" "test-results" "allure-results"

      - name: Install Allure3 CLI
        if: always()
        run: |
          chmod +x scripts/ci/install-allure3-cli.sh
          ./scripts/ci/install-allure3-cli.sh "${{ inputs.allure_version || '3.0.0' }}"

      - name: Generate Allure Report
        if: always()
        run: |
          echo "Generating Allure report for ${{ inputs.environment }}..."
          # Allure3 CLI: Remove old report directory first, then generate
          rm -rf allure-report-${{ inputs.environment }}
          allure generate allure-results -o allure-report-${{ inputs.environment }}
          echo "âœ… Report generated!"

      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-${{ inputs.environment }}
          path: allure-report-${{ inputs.environment }}/
          retention-days: 7
          if-no-files-found: ignore

  environment-test-summary:
    name: Test Summary (${{ inputs.environment }})
    runs-on: ubuntu-latest
    needs: [smoke-tests, grid-tests, mobile-browser-tests, responsive-design-tests, cypress-tests, playwright-tests, robot-tests, selenide-tests, vibium-tests]  # Wait for ALL tests (Groups 3 + 4)
    if: always()

    steps:
      - name: List available artifacts (debug)
        if: always()
        run: |
          echo "ğŸ” Checking for artifacts matching pattern: *-results-${{ inputs.environment }}"
          echo "Expected artifact patterns:"
          echo "  - smoke-results-${{ inputs.environment }}"
          echo "  - grid-results-*-${{ inputs.environment }}"
          echo "  - mobile-results-${{ inputs.environment }}"
          echo "  - responsive-results-${{ inputs.environment }}"
          echo "  - cypress-results-${{ inputs.environment }}"
          echo "  - playwright-results-${{ inputs.environment }}"
          echo "  - robot-results-${{ inputs.environment }}"
          echo "  - selenide-results-${{ inputs.environment }}"
          echo "  - vibium-results-${{ inputs.environment }}"

      - name: Download test results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: "*-results-${{ inputs.environment }}"
          path: test-results
          merge-multiple: true

      - name: Create test summary
        run: |
          chmod +x scripts/ci/generate-environment-test-summary.sh
          ./scripts/ci/generate-environment-test-summary.sh \
            "${{ inputs.environment }}" \
            "${{ inputs.base_url }}" \
            "${{ inputs.test_suite }}" \
            "test-results" \
            "$GITHUB_STEP_SUMMARY"
